version: 2.1

orbs:
  slack: circleci/slack@4.8
  rok8s-scripts: fairwinds/rok8s-scripts@11.11.5

commands:
  set_environment_variables:
    description: Sets environment variables for this job.
    steps:
    - run: ./.circleci/scripts/env.sh

  set_tags:
    description: Figures out which plugins have been changed etc
    steps:
    - run: ./.circleci/set_tags.sh

  docker_build:
    description: Build docker Images
    steps:
    - checkout
    - setup_remote_docker
    - set_environment_variables
    - set_tags
    - run:
        name: Build Plugin Docker Images
        command: |
          for plugin in "${CHANGED[@]}"; do
            docker-pull -f ./plugins/$plugin/build.config
            ROK8S_DOCKER_BUILD_EXTRAARGS="--no-cache" docker-build -f ./plugins/$plugin/build.config
          done

  docker_push_plugins:
    description: Push docker images that were built
    steps:
    - run:
        name: Push Plugin Docker Images
        command: |
          docker login quay.io -u="${fairwinds_quay_user}" -p="${fairwinds_quay_token}"
          for plugin in "${CHANGED[@]}"; do
            docker-push -f ./plugins/$plugin/build.config
          done

  insights_test:
    description: Fairwinds Insights CI integration
    steps:
    - run:
        name: Run Insights CI script
        command: |
          if [ ${#CHANGED[@]} -gt 0 ]; then
            echo "images:" >> fairwinds-insights.yaml
            echo "  docker:" >> fairwinds-insights.yaml
            for plugin in "${CHANGED[@]}"; do
              source ./plugins/$plugin/build.config
              echo "  - quay.io/$REPOSITORY_NAME:latest" >> fairwinds-insights.yaml
            done
            cat fairwinds-insights.yaml
            curl -L https://insights.fairwinds.com/v0/insights-ci.sh > ci-script.sh
            chmod +x ci-script.sh
            ./ci-script.sh
          fi

  check_version_changed:
    description: Check that version.txt changed if folder changed
    steps:
    - run:
        name: Check version.txt
        command: |
          if [ "$CIRCLE_BRANCH" == "main" ]
          then
            exit 0
          fi
          for plugin in "${CHANGED[@]}"; do
            if git diff --name-only --exit-code origin/main "./plugins/$plugin/version.txt" ; then
              echo "Please update ./plugins/$plugin/version.txt"
              exit 1
            elif ! grep -q "## $(cat ./plugins/$plugin/version.txt)" "./plugins/$plugin/CHANGELOG.md"; then
              echo "Please update ./plugins/$plugin/CHANGELOG.md"
              exit 1
            else
              echo "Update to ./plugins/$plugin/version.txt found"
            fi
          done

executors:
  ci-images:
    docker:
      - image: quay.io/reactiveops/ci-images:v11-stretch
  ci-images-large:
    resource_class: large
    docker:
      - image: quay.io/reactiveops/ci-images:v11-stretch


jobs:
  build_plugins:
    executor: ci-images
    steps:
      - docker_build
      - insights_test
      - slack/notify:
          event: fail
          branch_pattern: main
          template: basic_fail_1

  build_and_push_plugins:
    executor: ci-images-large
    steps:
      - docker_build
      - insights_test
      - docker_push_plugins
      - slack/notify:
          event: fail
          branch_pattern: main
          template: basic_fail_1

  test:
    working_directory: /go/src/github.com/fairwindsops/insights-plugins/
    docker:
      - image: circleci/golang:1.17
    steps:
      - checkout
      - set_environment_variables
      - set_tags
      - run: go get -u golang.org/x/lint/golint
      - run: |
          for plugin in "${GO_PKGS[@]}"; do
            echo "linting $plugin"
            cd plugins/$plugin
            # TODO: fix lint errors
            # go list ./... | xargs golint -set_exit_status
            cd ../..
          done
      - run: cd plugins/opa ; go test ./... ; cd ../..
      - run: cd plugins/admission ; go test ./... ; cd ../..
      - run: cd plugins/ci ; go test ./... ; cd ../..
      - slack/notify:
          event: fail
          branch_pattern: main
          template: basic_fail_1

  check_version_changed:
    working_directory: /go/src/github.com/fairwindsops/insights-plugins/
    docker:
      - image: circleci/golang:1.12
    steps:
      - checkout
      - set_environment_variables
      - set_tags
      - check_version_changed

  scan_for_vulnerabilities:
    working_directory: /go/src/github.com/fairwindsops/insights-plugins/
    executor: ci-images
    steps:
      - checkout
      - set_environment_variables
      - setup_remote_docker
      - run: ./.circleci/scripts/install-trivy.sh
      - run: ./scripts/scan-all.sh
      - slack/notify:
          event: fail
          custom: |
            {
                "text": "One or more images in insights-plugins have vulnerabilities",
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "One or more images in insights-plugins have vulnerabilities!\n\n$VULNERABLE_IMAGES_LIST"
                        }
                    }
                ]
            }
      - slack/notify:
          event: pass
          custom: |
            {
                "text": "All images in insights-plugins are clean",
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": ":tada: All images in insights-plugins are clean!"
                        }
                    }
                ]
            }

workflows:
  version: 2
  release:
    jobs:
      - test
      - check_version_changed
      - build_plugins:
          filters:
            branches:
              only:
              - /pull\/[0-9]+/
      - build_and_push_plugins:
          context: org-global
          requires:
            - check_version_changed
          filters:
            branches:
              ignore:
              - /pull\/[0-9]+/
      - rok8s-scripts/kubernetes_e2e_tests:
          name: End-To-End Test on Kubernetes
          requires:
            - build_and_push_plugins
          pre_script: e2e/pre.sh
          script: e2e/ci.sh
          store-artifacts: /workspace/output
  check_vulnerabilities:
    jobs:
      - scan_for_vulnerabilities
    triggers:
      - schedule:
          cron: "0 */6 * * *"
          filters:
            branches:
              only:
                - main
