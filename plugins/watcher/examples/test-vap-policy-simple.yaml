apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: test-vap-policy-simple
  annotations:
    policies.kyverno.io/title: Test VAP Policy (Simple)
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: >-
      This policy creates a ValidatingAdmissionPolicy that blocks deployments
      with hostPath volumes and generates audit events for monitoring.
spec:
  # Enable admission control to generate VAPs
  admission: true
  # Run in background to generate events
  background: true
  # Use Enforce mode to block resources and generate events
  validationFailureAction: Enforce
  rules:
  - name: block-hostpath-volumes
    match:
      any:
      - resources:
          kinds:
          - Deployment
    validate:
      cel:
        expressions:
        - expression: '!has(object.spec.template.spec.volumes) || object.spec.template.spec.volumes.all(volume, !has(volume.hostPath))'
          message: 'HostPath volumes are forbidden in Deployments. The field spec.template.spec.volumes[*].hostPath must be unset.'

