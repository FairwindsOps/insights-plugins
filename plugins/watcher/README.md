# Kubernetes Event Watcher

A Kubernetes plugin that watches policy-related resources and events, with special focus on policy violations that block resource installation. Now includes **VAP Interceptor** functionality to capture and audit ValidatingAdmissionPolicy violations that would otherwise be blocked without generating events.

## Features

- **Policy Event Watching**: Watches Kubernetes events and policy resources for policy violations
- **Policy Violation Detection**: Automatically detects and processes policy violations that block resource installation
- **VAP Interceptor**: Captures ValidatingAdmissionPolicy violations and generates synthetic events for audit
- **Multi-format Support**: Handles both ValidatingAdmissionPolicy and regular Kyverno policy events
- **Insights Integration**: Sends blocked policy violations directly to Fairwinds Insights API
- **Real-time Processing**: Processes events as they occur in the cluster
- **Kyverno Integration**: Monitors Kyverno policy reports and cluster policy reports
- **Admission Control**: Tracks ValidatingAdmissionPolicy and MutatingAdmissionPolicy resources
- **Event-driven VAP Monitoring**: Monitors existing Kubernetes events for VAP violations and generates synthetic events

## Usage

### Basic Usage

```bash
# Watch policy-related resources and events
./insights-event-watcher

# Set log level
./insights-event-watcher --log-level=debug

# Enable VAP interceptor functionality
./insights-event-watcher --enable-vap-interceptor=true --vap-interceptor-port=8080
```

### Command Line Options

- `--log-level`: Log level - debug, info, warn, error (default: `info`)
- `--insights-host`: Fairwinds Insights hostname (optional)
- `--organization`: Fairwinds organization name (required if insights-host provided)
- `--cluster`: Cluster name (required if insights-host provided)
- `--insights-token`: Fairwinds Insights API token (required if insights-host provided)
- `--enable-vap-interceptor`: Enable VAP interceptor functionality (default: `false`)
- `--vap-interceptor-port`: Port for VAP interceptor webhook server (default: `8080`)

### VAP Interceptor

The VAP Interceptor solves the challenge of auditing ValidatingAdmissionPolicy violations that block resource creation. Since VAPs run before admission webhooks in the Kubernetes admission chain, blocked requests never reach webhook endpoints, making it impossible to generate events for audit purposes.

#### How VAP Interceptor Works

1. **Event-driven Monitoring**: Monitors existing Kubernetes events for VAP violation indicators
2. **Synthetic Event Generation**: Creates `VAPViolation` events for detected VAP violations
3. **Policy Details Extraction**: Extracts policy names and violation details from original events
4. **Insights Integration**: Sends synthetic events to Fairwinds Insights for audit

#### VAP Interceptor Features

- **Non-intrusive**: Does not interfere with normal admission requests
- **Generic Detection**: Works with any VAP policy without hardcoded checks
- **Event-driven**: Monitors existing Kubernetes events rather than intercepting requests
- **Synthetic Events**: Generates `VAPViolation` events that are processed by the standard PolicyViolationHandler
- **Duplicate Prevention**: Prevents creation of duplicate synthetic events

### PolicyViolation Event Processing

The watcher provides special processing for PolicyViolation events:

- **Real-time Detection**: Captures `PolicyViolation` and `VAPViolation` events as they occur
- **Blocked Policy Analysis**: Specifically identifies blocked policy violations that prevent resource installation
- **Insights API Integration**: Automatically sends any blocked policy violation to Fairwinds Insights
- **Multi-format Support**: Handles both ValidatingAdmissionPolicy and regular Kyverno policy events
- **Synthetic Event Support**: Processes synthetic `VAPViolation` events generated by the VAP interceptor
- **Extensible Architecture**: Easy to add new event handlers for future requirements

#### Supported PolicyViolation Event Types

The watcher sends **any** PolicyViolation event that blocks resource installation:

- ✅ **ValidatingAdmissionPolicy events**: `validatingadmissionpolicy/policy-name` with `(blocked)`
- ✅ **Regular Kyverno policy events**: `deployment/nginx` with `policy namespace/policy-name fail (blocked): ...`
- ✅ **Synthetic VAPViolation events**: `VAPViolation` events generated by the VAP interceptor
- ❌ **Non-blocked events**: Any violation without `(blocked)` in the message (warnings, audit violations)

#### Example PolicyViolation Events

```bash
# These events will be captured and sent to Insights API:
kubectl get events | grep -E "PolicyViolation|VAPViolation" | grep "(blocked)"

# ValidatingAdmissionPolicy format:
Warning   PolicyViolation     validatingadmissionpolicy/disallow-host-path   Deployment default/nginx: [disallow-host-path] fail (blocked); HostPath volumes are forbidden...

# Regular Kyverno policy format:
Warning   PolicyViolation     deployment/nginx                               policy disallow-host-path/disallow-host-path fail (blocked): HostPath volumes are forbidden...

# Synthetic VAPViolation format (generated by VAP interceptor):
Warning   VAPViolation        replicaset/nginx-578557b98b                   VAP Policy Violation: ReplicaSet default/nginx-578557b98b: [disallow-host-path] fail; HostPath volumes are forbidden...
```

#### Creating Policies That Generate Blocked Events

To generate events that will be sent to Insights, create policies with blocking behavior:

**Kyverno Policy Example:**
```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-path
spec:
  validationFailureAction: Enforce  # This generates "(blocked)" events
  rules:
  - name: disallow-host-path
    match:
      resources:
        kinds: [Pod]
    validate:
      message: "HostPath volumes are forbidden"
      pattern:
        spec:
          =(volumes):
            - X(hostPath): "null"
```

**ValidatingAdmissionPolicy Example:**
```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: disallow-host-path
spec:
  failurePolicy: Fail  # This generates "(blocked)" events
  validations:
  - expression: "!has(object.spec.volumes) || !object.spec.volumes.exists(v, has(v.hostPath))"
    message: "HostPath volumes are forbidden"
  matchConstraints:
    resourceRules:
    - apiGroups: [""]
      apiVersions: ["v1"]
      operations: ["CREATE", "UPDATE"]
      resources: ["pods"]
```

#### Usage with Insights API

```bash
# Run with Insights API integration
./insights-event-watcher \
  --insights-host=https://insights.fairwinds.com \
  --organization=my-org \
  --cluster=production \
  --insights-token=your-api-token

# Run with VAP interceptor enabled
./insights-event-watcher \
  --enable-vap-interceptor=true \
  --vap-interceptor-port=8080 \
  --insights-host=https://insights.fairwinds.com \
  --organization=my-org \
  --cluster=production \
  --insights-token=your-api-token
```

### Extensible Event Handler System

The watcher uses a factory pattern for event handling, making it easy to add new event types:

- **PolicyViolation Events**: Captures any blocked policy violation (ValidatingAdmissionPolicy or Kyverno) and sends to Insights API
- **VAPViolation Events**: Processes synthetic VAPViolation events generated by the VAP interceptor
- **Kyverno Resources**: Handles PolicyReport, ClusterPolicyReport, Policy, and ClusterPolicy events
- **Generic Resources**: Fallback handler for any other Kubernetes resources
- **Easy Extension**: Add new handlers by implementing the `EventHandler` interface

#### Handler Architecture

```go
type EventHandler interface {
    Handle(watchedEvent *event.WatchedEvent) error
}
```

The factory automatically selects the most appropriate handler based on:
1. **Event characteristics** (e.g., `reason: PolicyViolation` or `reason: VAPViolation` → `policy-violation` handler)
2. **Resource type naming convention** (e.g., `PolicyReport` → `policyreport-handler`)
3. **Fallback to generic handler** for unmatched resources

**No `CanHandle` method needed** - the factory uses a simple naming convention!

#### Watched Resources
- **events** - Kubernetes events (CRITICAL for policy violations)
- **PolicyReport, ClusterPolicyReport** - Kyverno policy reports
- **Policy, ClusterPolicy** - Kyverno policies
- **ValidatingAdmissionPolicy, ValidatingAdmissionPolicyBinding** - Admission control policies
- **MutatingAdmissionPolicy, MutatingAdmissionPolicyBinding** - Admission control policies

## Building

```bash
# Build for local development
go build -o insights-event-watcher ./cmd/insights-event-watcher/main.go

# Build for Linux (for Docker)
GOOS=linux GOARCH=amd64 go build -o insights-event-watcher ./cmd/insights-event-watcher/main.go
```

## Docker

```bash
# Build Docker image
docker build -t insights-event-watcher .

# Run with VAP interceptor enabled
docker run -p 8080:8080 insights-event-watcher --enable-vap-interceptor=true --vap-interceptor-port=8080
```

## Deployment

### Kubernetes Deployment

The watcher can be deployed as a Kubernetes deployment with VAP interceptor functionality:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: insights-event-watcher
  namespace: insights-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: insights-event-watcher
  template:
    metadata:
      labels:
        app: insights-event-watcher
    spec:
      containers:
      - name: watcher
        image: insights-event-watcher:latest
        command: ["/usr/local/bin/insights-event-watcher"]
        args:
        - "--enable-vap-interceptor=true"
        - "--vap-interceptor-port=8080"
        - "--insights-host=https://insights.fairwinds.com"
        - "--organization=my-org"
        - "--cluster=production"
        - "--insights-token=your-api-token"
        ports:
        - containerPort: 8080
          name: webhook
```

### Testing VAP Interceptor

To test the VAP interceptor functionality:

1. **Deploy the watcher** with VAP interceptor enabled
2. **Create a VAP policy** that blocks resource creation
3. **Attempt to create a violating resource**
4. **Check for synthetic VAPViolation events**:

```bash
# Check for VAPViolation events
kubectl get events -A | grep VAPViolation

# Check watcher logs for VAP interceptor activity
kubectl logs -n insights-agent deployment/insights-event-watcher | grep -i "vap"
```

## Configuration

The watcher uses in-cluster configuration by default. Ensure it has appropriate RBAC permissions to watch the desired resources.

### Required RBAC Permissions

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: watcher
rules:
# Kubernetes events - CRITICAL for policy violation detection
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch"]
# Kyverno policy resources
- apiGroups: ["wgpolicyk8s.io"]
  resources: ["policyreports", "clusterpolicyreports", "policies", "clusterpolicies"]
  verbs: ["get", "list", "watch"]
# ValidatingAdmissionPolicy resources
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingadmissionpolicies", "validatingadmissionpolicybindings", "mutatingadmissionpolicies", "mutatingadmissionpolicybindings"]
  verbs: ["get", "list", "watch"]
```

## Event Types

- `ADDED`: Resource was created
- `MODIFIED`: Resource was updated
- `DELETED`: Resource was deleted
- `ERROR`: Error occurred while watching

## Logging

The watcher provides structured logging with the following fields:
- `event_type`: Type of Kubernetes event
- `resource_type`: Type of resource
- `namespace`: Resource namespace
- `name`: Resource name
- `uid`: Resource UID
- `timestamp`: Event timestamp

## Troubleshooting

### VAP Interceptor Issues

**Problem**: VAP violations are not generating synthetic events
- **Check**: Ensure VAP interceptor is enabled with `--enable-vap-interceptor=true`
- **Check**: Verify VAP policies are actually blocking resources (not in audit mode)
- **Check**: Look for VAP event monitor logs: `kubectl logs deployment/insights-event-watcher | grep "VAP event monitor"`

**Problem**: Synthetic VAPViolation events are not being processed
- **Check**: Verify handler selection logic includes VAPViolation events
- **Check**: Look for PolicyViolationHandler logs: `kubectl logs deployment/insights-event-watcher | grep "VAPViolation"`
- **Check**: Ensure synthetic events have correct format: `"VAP Policy Violation: [original message]"`

**Problem**: Duplicate synthetic events being created
- **Check**: The VAP interceptor includes duplicate prevention logic
- **Check**: Look for "already exists" messages in logs

### General Issues

**Problem**: No policy violations being sent to Insights
- **Check**: Ensure events contain `(blocked)` or `fail:` in the message
- **Check**: Verify Insights API credentials are correct
- **Check**: Look for "Sending blocked policy violation to Insights" log messages

**Problem**: Watcher not detecting events
- **Check**: Verify RBAC permissions include `watch` on `events` resource
- **Check**: Ensure the watcher is running in the correct namespace
- **Check**: Look for "No handler found for event" debug messages

