#!/usr/bin/env bash
# MetalLB will provision a loadbalancer in clusters that do not otherwise have
# a loadbalancer provisioner.
# This is intended in non-cloud environments.
# Using a MetalLB-managed loadbalancer will not work with a KIND cluster on 
# Windows or Mac, but it does allow a loadbalancer Kubernetes
# Service to obtain an external IP to test this policy.
#
# It's recommended to only install this on a temporary / test cluster.

kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml
# The subnet used in this ConfigMap does not matter,
# since traffic will not be routable to it anyhow.
kubectl apply -f https://kind.sigs.k8s.io/examples/loadbalancer/metallb-configmap.yaml
echo This MetalLB installation can later be cleaned up by running: kubectl delete namespace metallb-system
