package fairwinds

import rego.v1

# Optionally adjust the `badPaths` variable below.

podHasHostPathVolume(pod) if {
	# Get the volumes from each container
	volumes := pod.spec.volumes[_]
	volumes.hostPath
}

blockMountPath(volumeMount) if {
	# List volume mount paths that will be blocked.
	badPaths := ["/etc/hosts", "/etc/hostname", "/etc/resolv.conf"]
	badPath := badPaths[_]
	volumeMount.mountPath == badPath
}

podHasDangerousVolumeMount(pod) if {
	container := pod.spec.containers[_]
	volumeMount := container.volumeMounts[_]
	blockMountPath(volumeMount)
}

checkCronjob contains actionItem if {
	input.kind == "CronJob"
	pod := input.spec.jobTemplate.spec.template
	podHasHostPathVolume(pod)
	podHasDangerousVolumeMount(pod)
	actionItem := {
		"title": concat(" ", [input.kind, " may be exploiting CVE-2021-43816"]),
		"description": "Pod has a hostPath mount and a volumeMount at a vulnerable path. It may be exploiting CVE-2021-43816",
		"remediation": "Immediately investigate this workload and mitigate CVE-2021-43816",
		"category": "Security",
		"severity": .99,
	}
}

checkDeploymentLike contains actionItem if {
	kinds := {"Deployment", "DaemonSet", "StatefulSet", "ReplicaSet", "Job"}
	kind := kinds[_]
	input.kind == kind
	pod := input.spec.template
	podHasHostPathVolume(pod)
	podHasDangerousVolumeMount(pod)
	actionItem := {
		"title": concat(" ", [input.kind, " may be exploiting CVE-2021-43816"]),
		"description": "Pod has a hostPath mount and a volumeMount at a vulnerable path. It may be exploiting CVE-2021-43816",
		"remediation": "Immediately investigate this workload and mitigate CVE-2021-43816",
		"category": "Security",
		"severity": .99,
	}
}

checkPod contains actionItem if {
	input.kind == "Pod"

	# Only alert for stand-alone pods,
	# avoiding duplicate action-items for pods which belong to a controller.
	not input.metadata.ownerReferences
	podHasHostPathVolume(input)
	podHasDangerousVolumeMount(input)
	actionItem := {
		"title": concat(" ", [input.kind, " may be exploiting CVE-2021-43816"]),
		"description": "Pod has a hostPath mount and a volumeMount at a vulnerable path. It may be exploiting CVE-2021-43816",
		"remediation": "Immediately investigate this workload and mitigate CVE-2021-43816",
		"category": "Security",
		"severity": .99,
	}
}
